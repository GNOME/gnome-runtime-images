image: 'registry.fedoraproject.org/fedora:30'

# Buildah can't use 'overlay' driver when running inside docker
variables:
    STORAGE_DRIVER: vfs

stages:
    - base
    - runtimes
    - rust_bundle

# Expects ${DOCKERIMAGE} which should be the name+tag of the registry image.
# Expects ${DOCKERFILE} variable which should be the path to the Dockerfile.
.build_template:
    tags:
        - privileged
    script:
        # For debugging
        - echo ${DOCKERFILE} / ${DOCKERIMAGE}
        - dnf install -y buildah podman
        - buildah login -u gitlab-ci-token -p ${CI_JOB_TOKEN} ${CI_REGISTRY}

        # Newer versions of podman/buildah try to set overlayfs mount options when
        # using the vfs driver, and this causes errors.
        - sed -i '/^mountopt =.*/d' /etc/containers/storage.conf

        - buildah bud --format=docker --pull -f ${DOCKERFILE} -t ${DOCKERIMAGE} .
        - buildah push ${DOCKERIMAGE}
    after_script:
        # don't try to use systemd/journald
        - |
          cat >> /etc/containers/libpod.conf << END
          cgroup_manager = "cgroupfs"
          events_logger = "file"
          END
        - podman run --rm ${DOCKERIMAGE} flatpak list --columns=application,branch,arch,active,size
        - buildah inspect --format "{{.FromImageID}}" ${DOCKERIMAGE}
    only:
        - master
        - triggers
        - schedules
    retry: 1

base:
    stage: base
    extends: .build_template
    variables:
        DOCKERIMAGE: ${CI_REGISTRY_IMAGE}/base
        DOCKERFILE: base

flat-manager-client:
    stage: base
    extends: .build_template
    variables:
        DOCKERIMAGE: ${CI_REGISTRY_IMAGE}/flat-manager-client
        DOCKERFILE: flat-manager-client/Dockerfile

gnome:master:
    stage: runtimes
    extends: .build_template
    variables:
        DOCKERIMAGE: ${CI_REGISTRY_IMAGE}/gnome:master
        DOCKERFILE: gnome-master/Dockerfile

gnome:3.32:
    stage: runtimes
    extends: .build_template
    variables:
        DOCKERIMAGE: ${CI_REGISTRY_IMAGE}/gnome:3.32
        DOCKERFILE: gnome-3-32/Dockerfile

gnome:3.34:
    stage: runtimes
    extends: .build_template
    variables:
        DOCKERIMAGE: ${CI_REGISTRY_IMAGE}/gnome:3.34
        DOCKERFILE: gnome-3-34/Dockerfile

gnome:3.36:
    stage: runtimes
    extends: .build_template
    variables:
        DOCKERIMAGE: ${CI_REGISTRY_IMAGE}/gnome:3.36
        DOCKERFILE: gnome-3-36/Dockerfile

rust master:
    stage: rust_bundle
    extends: .build_template
    before_script:
        - export BASE_IMAGE="registry.gitlab.gnome.org/gnome/gnome-runtime-images/gnome:master"
        - export BRANCH="19.08"
        - sed -e "s|@BASE_IMAGE@|$BASE_IMAGE|" sdk-bundles/rust-bundle.template > sdk-bundles/rust
        - sed -i "s|@BRANCH@|$BRANCH|" sdk-bundles/rust
    variables:
        DOCKERIMAGE: ${CI_REGISTRY_IMAGE}/rust_bundle:master
        DOCKERFILE: sdk-bundles/rust

rust 3.32:
    stage: rust_bundle
    extends: .build_template
    before_script:
        - export BASE_IMAGE="registry.gitlab.gnome.org/gnome/gnome-runtime-images/gnome:3.32"
        - export BRANCH="18.08"
        - sed -e "s|@BASE_IMAGE@|$BASE_IMAGE|" sdk-bundles/rust-bundle.template > sdk-bundles/rust
        - sed -i "s|@BRANCH@|$BRANCH|" sdk-bundles/rust
    variables:
        DOCKERIMAGE: ${CI_REGISTRY_IMAGE}/rust_bundle:3.32
        DOCKERFILE: sdk-bundles/rust

rust 3.34:
    stage: rust_bundle
    extends: .build_template
    before_script:
        - export BASE_IMAGE="registry.gitlab.gnome.org/gnome/gnome-runtime-images/gnome:3.34"
        - export BRANCH="19.08"
        - sed -e "s|@BASE_IMAGE@|$BASE_IMAGE|" sdk-bundles/rust-bundle.template > sdk-bundles/rust
        - sed -i "s|@BRANCH@|$BRANCH|" sdk-bundles/rust
    variables:
        DOCKERIMAGE: ${CI_REGISTRY_IMAGE}/rust_bundle:3.34
        DOCKERFILE: sdk-bundles/rust

rust 3.34:
    stage: rust_bundle
    extends: .build_template
    before_script:
        - export BASE_IMAGE="registry.gitlab.gnome.org/gnome/gnome-runtime-images/gnome:3.36"
        - export BRANCH="19.08"
        - sed -e "s|@BASE_IMAGE@|$BASE_IMAGE|" sdk-bundles/rust-bundle.template > sdk-bundles/rust
        - sed -i "s|@BRANCH@|$BRANCH|" sdk-bundles/rust
    variables:
        DOCKERIMAGE: ${CI_REGISTRY_IMAGE}/rust_bundle:3.36
        DOCKERFILE: sdk-bundles/rust
